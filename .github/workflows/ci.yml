name: CI

on:
  push:
    branches: [main, staging, develop]
  pull_request:
    branches: [main, staging, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  guardrails:
    name: Guardrails (LOC Budget)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce LOC budget on changed files
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            base="origin/${{ github.base_ref }}"
          else
            base="${{ github.event.before }}"
            if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
              base="HEAD~1"
            fi
          fi
          python3 scripts/enforce_loc.py --mode diff --base-ref "$base"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [guardrails]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linter
        run: bun run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    needs: [guardrails]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run typecheck
        run: bun run typecheck

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build
        env:
          DATABASE_URL: "postgresql://localhost:5432/test"
          BETTER_AUTH_SECRET: "test-secret-for-ci-build-only-32chars"
          BETTER_AUTH_URL: "http://localhost:3000"
          POLAR_ACCESS_TOKEN: "test-token"
          POLAR_SUCCESS_URL: "http://localhost:3001/success"
          CORS_ORIGIN: "http://localhost:3001"
          VITE_SERVER_URL: "http://localhost:3000"

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests
        run: bun run test
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/test"
          BETTER_AUTH_SECRET: "test-secret-for-ci-build-only-32chars"
          BETTER_AUTH_URL: "http://localhost:3000"
          POLAR_ACCESS_TOKEN: "test-token"
          POLAR_SUCCESS_URL: "http://localhost:3001/success"
          CORS_ORIGIN: "http://localhost:3001"

  docker-build:
    name: Docker Build (Web + Intelligence)
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare env (compose requires drovi-intelligence/.env)
        run: cp drovi-intelligence/.env.example drovi-intelligence/.env

      - name: Build Docker images
        run: docker compose -f docker-compose.yml build drovi-intelligence web

      - name: Intelligence import boundaries (import-linter)
        run: docker compose -f docker-compose.yml run --no-deps --rm drovi-intelligence lint-imports --config importlinter.ini

      - name: OpenAPI snapshot drift (determinism)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p openapi
          docker compose -f docker-compose.yml run --no-deps --rm drovi-intelligence \
            python scripts/generate_openapi.py > openapi/openapi.generated.json
          diff -u openapi/openapi.json openapi/openapi.generated.json

      - name: OpenAPI breaking-change detection (removals)
        run: python3 scripts/openapi_break_check.py --baseline openapi/openapi.json --current openapi/openapi.generated.json

  smoke:
    name: Docker Smoke Test (/health + /api/v1/auth/me)
    runs-on: ubuntu-latest
    needs: [docker-build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare env (compose requires drovi-intelligence/.env)
        run: cp drovi-intelligence/.env.example drovi-intelligence/.env

      - name: Start stack
        run: |
          docker compose -f docker-compose.yml up -d --build \
            postgres falkordb redis redpanda redpanda-init minio minio-init drovi-intelligence web

      - name: Wait for API health
        run: |
          set -e
          for i in $(seq 1 60); do
            if curl -sf http://localhost:3001/health >/dev/null; then
              echo "health ok"
              break
            fi
            sleep 2
          done
          curl -sf http://localhost:3001/health >/dev/null

      - name: Auth endpoint reachable (expect 200 or 401)
        run: |
          set -e
          code="$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/v1/auth/me)"
          echo "status=$code"
          if [ "$code" != "200" ] && [ "$code" != "401" ]; then
            echo "Unexpected status code for /api/v1/auth/me: $code"
            exit 1
          fi

      - name: Performance budget (informational)
        run: |
          python3 scripts/perf_budget.py \
            --base-url http://localhost:3001 \
            --samples 25 \
            --timeout-s 5 \
            --output perf/perf-budget.json

      - name: Upload perf artifact (informational)
        uses: actions/upload-artifact@v4
        with:
          name: perf-budget
          path: perf/perf-budget.json

      - name: Intelligence unit tests (coverage)
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            base="origin/${{ github.base_ref }}"
          else
            base="${{ github.event.before }}"
            if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
              base="HEAD~1"
            fi
          fi

          docker compose -f docker-compose.yml run --no-deps --name drovi-intel-pytest \
            -e ENVIRONMENT=test \
            drovi-intelligence \
            pytest -q tests/guardrails tests/api tests/test_orchestrator.py -m unit \
              --cov=src --cov-report=term-missing --cov-report=json:/tmp/coverage.json --maxfail=1

          mkdir -p drovi-intelligence/.coverage
          docker cp drovi-intel-pytest:/tmp/coverage.json drovi-intelligence/.coverage/current.json
          docker rm drovi-intel-pytest

          python3 drovi-intelligence/scripts/coverage_ratchet.py \
            --baseline drovi-intelligence/.coverage/baseline.json \
            --current drovi-intelligence/.coverage/current.json \
            --base-ref "$base" \
            --min-changed-file-percent 80.0

      - name: Upload coverage artifact (informational)
        uses: actions/upload-artifact@v4
        with:
          name: drovi-intelligence-coverage-json
          path: drovi-intelligence/.coverage/current.json

      - name: Dump logs (on failure)
        if: failure()
        run: |
          docker compose -f docker-compose.yml ps
          docker compose -f docker-compose.yml logs --no-color --tail=300

      - name: Shutdown
        if: always()
        run: docker compose -f docker-compose.yml down -v
