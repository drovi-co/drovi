groups:
  - name: drovi-intelligence
    rules:
      - alert: DroviHighErrorRate
        expr: |
          sum(rate(drovi_http_requests_total{status_code=~"5.."}[5m]))
          /
          sum(rate(drovi_http_requests_total[5m]))
          > 0.05
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "High 5xx error rate"
          description: "HTTP 5xx error rate > 5% for 10m"

      - alert: DroviAPIErrorBudgetBurn1h
        expr: |
          (
            sum(rate(drovi_http_requests_total{status_code=~"5.."}[1h]))
            /
            sum(rate(drovi_http_requests_total[1h]))
          ) / 0.001 > 14.4
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "API error budget burn fast (1h)"
          description: "99.9% SLO error budget is burning too fast over 1h window."

      - alert: DroviAPIErrorBudgetBurn6h
        expr: |
          (
            sum(rate(drovi_http_requests_total{status_code=~"5.."}[6h]))
            /
            sum(rate(drovi_http_requests_total[6h]))
          ) / 0.001 > 6
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "API error budget burn (6h)"
          description: "99.9% SLO error budget burning over 6h window."

      - alert: DroviHighLatencyP95
        expr: |
          histogram_quantile(
            0.95,
            sum(rate(drovi_http_request_duration_seconds_bucket[5m])) by (le)
          ) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High API latency (p95)"
          description: "p95 latency > 1s for 10m"

      - alert: DroviLLMErrorRate
        expr: |
          sum(rate(drovi_llm_requests_total{status="error"}[10m]))
          /
          sum(rate(drovi_llm_requests_total[10m]))
          > 0.05
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "High LLM error rate"
          description: "LLM error rate > 5% for 15m"

      - alert: DroviConnectorStale
        expr: |
          time() - drovi_connector_last_success_timestamp_seconds > 3600
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Connector stale"
          description: "No successful connector sync for > 1h"

      - alert: DroviUemPersistSlow
        expr: |
          histogram_quantile(
            0.95,
            sum(rate(drovi_uem_persist_duration_seconds_bucket[5m])) by (le)
          ) > 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "UEM persist latency high"
          description: "p95 UEM persist > 500ms for 10m"

      - alert: DroviKafkaConsumerLagHigh
        expr: |
          max_over_time(drovi_kafka_consumer_lag[10m]) > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer lag high"
          description: "Kafka lag exceeded 1000 messages for 10m. Investigate consumer throughput."
